logLevel: debug
runners:
  tags: "nonprod,docker"
  name: "runner-nonprod"
  privileged: true
  runUntagged: true
  maximumTimeout: "3600"
  config: |
    [[runners]]
      output_limit = 4096
      [runners.kubernetes]
        namespace = "{{.Release.Namespace}}"
        image = "artifact.lotuss.com/dockerhub/library/ubuntu:18.04"
        privileged = true
        cpu_request = "200m"
        memory_request = "512Mi"
        helper_cpu_request = "100m"
        helper_memory_request = "128Mi"
        service_cpu_request = "100m"
        service_memory_request = "128Mi"
      [[runners.kubernetes.volumes.empty_dir]]
        name = "docker-certs"
        mount_path = "/certs/client"
        medium = "Memory"
        [runners.kubernetes.node_selector]
          "kubernetes.io/os"  = "linux"
        [runners.cache]
          Type = "s3"
          Path = "gitlab-runner"
          Shared = true
          # MaxUploadedArchiveSize = 0
          [runners.cache.s3]
            ServerAddress = "s3.amazonaws.com"
            BucketName = "minio-runner-cache"
            BucketLocation = "ap-southeast-1"
            Insecure = false


replicas: 2
gitlabUrl: https://repo.lotuss.com/
runnerRegistrationToken: cBp9n5twfYyUYZjvKWjEv0H79f1gCXQ11yhCLfcUlSLwjSSkRkgOi0DVZ8D5nHnZ
concurrent: 5

resources: 
  limits:
    memory: 512Mi
    cpu: 500m
  requests:
    memory: 128Mi
    cpu: 100m


# securityContext:
#   runAsNonRoot: false

rbac:
  create: true
  serviceAccountAnnotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::337171486236:role/gitlab-runner20221228073102698300000001

service:
  enabled: true

metrics:
  enabled: true
  serviceMonitor:
    enabled: true

nodeSelector:
  project: gitlab

keda: 
  minReplicas: 2
  maxReplicas: 6
  triggers:
  - type: prometheus
    metadata:
      serverAddress: http://prometheus-prometheus.monitoring.svc:9090
      metricName: gitlab_runner_jobs_sum
      threshold: '4'
      query: max_over_time(sum(gitlab_runner_jobs{job="gitlab-runner"})[5m:])

